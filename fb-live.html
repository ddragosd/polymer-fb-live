<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">


<!--
`fb-live`
Manages Facebook live settings

@demo demo/index.html 
-->

<dom-module id="fb-live">
    <template>
        <style>
            :host {
                display: block;
            }

            .container {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
            }

            paper-button.indigo {
                background-color: var(--paper-indigo-500);
                color: white;
                --paper-button-raised-keyboard-focus: {
                    background-color: var(--paper-pink-a200) !important;
                    color: white !important;
                };
            }


        </style>
        <!--<h2>Hello [[_userInfo.name]] </h2>-->

        <div class="floated-label-placeholder style-scope paper-input-container">Logged in as: [[_userInfo.name]]</div>

        <paper-dropdown-menu id="targetsDropDown" label="Select a destination" hidden="{{!_showTargets}}">
            <paper-listbox class="dropdown-content" selected="{{selectedTarget}}">
                <template is="dom-repeat" items="[[targets]]">
                    <paper-item>[[item.title]]</paper-item>
                </template>
            </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu id="privacyDropDown" label="Who should see this ?" hidden="{{!_showPrivacy}}">
            <paper-listbox class="dropdown-content" selected="{{selectedPrivacy}}">
                <paper-item>Public</paper-item>
                <paper-item>Friends</paper-item>
                <paper-item>Only me</paper-item>
            </paper-listbox>
        </paper-dropdown-menu>


        <paper-dropdown-menu id="pagesDropDown" label="Select a Page" hidden="{{!_showPages}}">
            <paper-listbox class="dropdown-content" selected="{{selectedPage}}">
                <template is="dom-repeat" items="[[_userInfo.accounts]]">
                    <paper-item>[[item.name]]</paper-item>
                </template>
            </paper-listbox>
        </paper-dropdown-menu>

        <paper-button raised class="custom indigo"
                      hidden="{{!_readyToStream}}"
                      on-tap="_goLive">
            <!--<iron-icon icon="play"></iron-icon>-->
            Go Live
        </paper-button>

    </template>

    <script>
        Polymer({

            is: 'fb-live',

            //https://www.polymer-project.org/1.0/docs/devguide/properties
            properties: {
                //
                userID: {
                    type: String,
                    value: 0,
                    notify: true,
                    observer: '_userIDChanged'
                },
                _userInfo: {
                    type: Object,
                    value: {
                        name: " please login first"
                    }
                },

                targets: {
                    type: Array,
                    value: [
                        {
                            type: "timeline",
                            title: "Share on your timeline"
                        },
                        {
                            type: "page",
                            title: "Share on a page you manage"
                        },
                        {
                            type: "event",
                            title: "Share on an event"
                        }
                    ],
                    notify: true
                },

                selectedTarget: {
                    type: Number,
                    value: 0,
                    notify: true,
                    observer: '_selectedTargetChanged'
                },

                selectedPrivacy: {
                    type: Number,
                    value: 0,
                    notify: true,
                    observer: '_selectedPrivacyChanged'
                },
                selectedPage: {
                    type: Number,
                    value: -1,
                    notify: true,
                    observer: '_selectedPageChanged'
                },

                _showTargets: {
                    type: Boolean,
                    value: false,
                    notify: true,
                },
                _showPrivacy: {
                    type: Boolean,
                    value: false,
                    notify: true,
                },

                _showPages: {
                    type: Boolean,
                    value: false,
                    notify: true,
                },

                _showEvents: {
                    type: Boolean,
                    value: false,
                    notify: true,
                },

                _readyToStream: {
                    type: Boolean,
                    value: false,
                    notify: true
                }
            },

            _userIDChanged: function (newValue, oldValue) {
                var scope = this;
                if (null == window['FB']) {
                    return;
                }

                if (newValue === null || typeof(newValue) === "undefined") {
                    scope._showTargets = false;
                    scope._showPrivacy = false;
                    scope._showPages = false;
                    scope._showEvents = false;
                    return;
                }

                scope._showTargets = true;
                scope._showPrivacy = true;

                FB.api('/me', function (response) {
                    scope._userInfo = response;

                });

                FB.api('/' + scope.userID + '/accounts', function (accounts) {
                    console.log(accounts);
                    scope.set('_userInfo.accounts', accounts.data);
                });
            },

            _selectedTargetChanged: function (newValue, oldValue) {
                var currentTarget = this.targets[newValue].type;
                console.log("Selected value is now: " + currentTarget);
                switch (this.targets[newValue].type) {
                    case "timeline":
                        this._showPrivacy = (this.userID !== 0);
                        this._showPages = false;
                        this._showEvents = true;
                        this._readyToStream = this.selectedPrivacy >= 0;
                        break;
                    case "page":
                        this._showPrivacy = false;
                        this._showPages = true;
                        this._showEvents = true;
                        this._readyToStream = this.selectedPage >= 0;
                        break;
                    case "event":
                        this._showPrivacy = false;
                        this._showPages = false;
                        this._showEvents = true;
                        break;
                }
            },

            _selectedPrivacyChanged: function (newValue, oldValue) {
                var currentTarget = this.targets[this.selectedTarget].type;
                console.log("_selectedPrivacyChanged:" + newValue + ";" + currentTarget);
                if (newValue >= 0 && currentTarget == "timeline") {
                    this._readyToStream = true;
                }
            },

            _selectedPageChanged: function (newValue, oldValue) {
                var currentTarget = this.targets[this.selectedTarget].type;
                console.log("_selectedPageChanged:" + newValue + ";" + currentTarget);
                if (newValue >= 0 && currentTarget == "page") {
                    this._readyToStream = true;
                }
            },

            // API DOCS: https://developers.facebook.com/docs/videos/live-video/getting-started#creating
            _goLive: function () {
                var scope = this;
                var currentTarget = this.targets[this.selectedTarget].type;
                switch (currentTarget) {
                    case "timeline":
                        // post a live event on the timeline
                        // POST /{user_id}/live_videos
                        FB.api('/' + this.userID + '/live_videos', "POST",
                                function (stream) {
                                    scope.fire('streaming', stream);
                                });
                        break;
                    case "page":
                        // post a live event on the selected page
                        // this.fire('kick', {kicked: true});
                        // POST /{page_id}/live_videos
                        var selectedAccount = scope._userInfo.accounts[scope.selectedPage].id;
                        FB.api('/' + selectedAccounts + '/live_videos', "POST",
                                function (stream) {
                                    scope.fire('streaming', stream);
                                });
                        break;
                    case "event":
                        // TODO: post a live event on the selected event
                        // POST /{event_id}/live_videos
                        break;
                }
            }

        });
    </script>
</dom-module>